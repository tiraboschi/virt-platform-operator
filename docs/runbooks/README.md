# Virt Platform Autopilot Alert Runbooks

This directory contains troubleshooting guides (runbooks) for alerts generated by virt-platform-autopilot.

## Alert Philosophy: "Silent when fine, precise when broken"

The virt-platform-autopilot follows a strict alerting philosophy:
- **No alerts** when the platform is in the Golden State
- **Precise alerts** when something requires operator attention
- **Actionable runbooks** with step-by-step troubleshooting

## Available Runbooks

### Critical Alerts

| Alert | Severity | Description | Runbook |
|-------|----------|-------------|---------|
| VirtPlatformSyncFailed | Critical | Asset failed to apply for >15min | [VirtPlatformSyncFailed.md](./VirtPlatformSyncFailed.md) |

### Warning Alerts

| Alert | Severity | Description | Runbook |
|-------|----------|-------------|---------|
| VirtPlatformThrashingDetected | Warning | Edit war detected, automation paused | [VirtPlatformThrashingDetected.md](./VirtPlatformThrashingDetected.md) |
| VirtPlatformDependencyMissing | Warning | Optional CRD missing, feature degraded | [VirtPlatformDependencyMissing.md](./VirtPlatformDependencyMissing.md) |

## Quick Diagnostic Commands

### Check Operator Health

```bash
# Check operator pod status
oc get pods -n openshift-cnv -l app=virt-platform-autopilot

# View recent logs
kubectl logs -n openshift-cnv -l app=virt-platform-autopilot --tail=100

# Follow logs in real-time
kubectl logs -n openshift-cnv -l app=virt-platform-autopilot -f
```

### Access Metrics

**Method 1: Port-forward (for interactive troubleshooting)**
```bash
# Port-forward to metrics endpoint (in a separate terminal)
kubectl port-forward -n openshift-cnv svc/virt-platform-autopilot-metrics 8080:8080

# Then query metrics locally
curl -s localhost:8080/metrics | grep virt_platform
```

**Method 2: Direct exec (for one-off queries)**
```bash
# Query all autopilot metrics
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- \
  curl -s localhost:8080/metrics | grep virt_platform

# Check compliance status (core health indicator)
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- \
  curl -s localhost:8080/metrics | grep virt_platform_compliance_status

# Check for resources failing to sync (compliance_status=0)
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- \
  curl -s localhost:8080/metrics | grep virt_platform_compliance_status | grep '} 0$'

# Check for thrashing (edit wars)
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- \
  curl -s localhost:8080/metrics | grep virt_platform_thrashing_total

# Check for missing dependencies
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- \
  curl -s localhost:8080/metrics | grep virt_platform_missing_dependency

# Check for missing dependencies (only show missing ones)
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- \
  curl -s localhost:8080/metrics | grep virt_platform_missing_dependency | grep '} 1$'
```

### Check Active Alerts

```bash
# Query Prometheus for active alerts (if Prometheus is installed)
oc get prometheusrule -n openshift-cnv virt-platform-autopilot-alerts -o yaml

# Query Alertmanager API (if Alertmanager is installed)
curl -s http://alertmanager-main.openshift-monitoring:9093/api/v2/alerts | \
  jq '.[] | select(.labels.operator=="virt-platform-autopilot")'
```

## Alert Metrics Reference

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `virt_platform_compliance_status` | Gauge | kind, name, namespace | 1=synced, 0=drifted/failed |
| `virt_platform_thrashing_total` | Counter | kind, name, namespace | Reconciliation throttling events |
| `virt_platform_customization_info` | Gauge | kind, name, namespace, type | Intentional customizations |
| `virt_platform_missing_dependency` | Gauge | group, version, kind | 1=missing, 0=present |
| `virt_platform_reconcile_duration_seconds` | Histogram | kind, name, namespace | Reconciliation latency |

## Common Resolution Patterns

### Pattern 1: Stop Automation (Intentional Change)

If you want to make manual changes and stop autopilot from managing a resource:

```bash
kubectl annotate <kind> <name> -n <namespace> \
  platform.kubevirt.io/mode=unmanaged
```

### Pattern 2: Partial Customization (Strategic Patch)

If you want autopilot to manage most fields but customize specific ones:

```bash
kubectl annotate <kind> <name> -n <namespace> \
  platform.kubevirt.io/patch='{"spec": {"yourField": "yourValue"}}'
```

### Pattern 3: Ignore Specific Fields

If you want autopilot to skip specific fields:

```bash
kubectl annotate <kind> <name> -n <namespace> \
  platform.kubevirt.io/ignore='spec.replicas,spec.template.spec.tolerations'
```

### Pattern 4: Force Reconciliation

If you want to trigger an immediate reconciliation:

```bash
kubectl annotate <kind> <name> -n <namespace> \
  platform.kubevirt.io/force-reconcile="$(date +%s)"
```

## Escalation Path

### L1: Self-Service (These Runbooks)
- Follow step-by-step troubleshooting
- Check logs and metrics
- Apply common resolution patterns

### L2: Autopilot Logs + Metrics Analysis
- Collect autopilot logs: `kubectl logs -n openshift-cnv -l app=virt-platform-autopilot --since=1h > autopilot.log`
- Export metrics: `oc exec -n openshift-cnv deploy/virt-platform-autopilot -- curl -s localhost:8080/metrics > metrics.txt`
- Check audit logs for external actors

### L3: GitHub Issues
- If the issue appears to be a bug in the autopilot
- Include: logs, metrics, resource YAML, steps to reproduce
- Repository: https://github.com/kubevirt/virt-platform-autopilot/issues

### L4: Red Hat Support (for OpenShift Customers)
- Open support case at https://access.redhat.com/support/cases/
- Include: must-gather output, autopilot logs, alert details
- Reference: "virt-platform-autopilot alert"

## Must-Gather for Support Cases

```bash
# Collect comprehensive diagnostic data
oc adm must-gather --image=registry.redhat.io/container-native-virtualization/cnv-must-gather-rhel9:latest

# Autopilot-specific diagnostics
kubectl logs -n openshift-cnv -l app=virt-platform-autopilot --all-containers --since=24h > autopilot-logs.txt
oc exec -n openshift-cnv deploy/virt-platform-autopilot -- curl -s localhost:8080/metrics > autopilot-metrics.txt
kubectl get all -n openshift-cnv -o yaml > autopilot-resources.yaml

# Resource snapshots
kubectl get <affected-kind> <affected-name> -n <namespace> -o yaml > affected-resource.yaml

# Audit logs (if accessible)
oc adm node-logs <master-node> --path=kube-apiserver/audit.log | \
  grep "<affected-resource-name>" > audit-trail.log
```

## Contributing

When adding new alerts:

1. Create alert definition in `assets/observability/prometheus-rules.yaml.tpl`
2. Add promtool tests in `test/promtool/alert_tests.yml`
3. Create corresponding runbook in this directory
4. Update this README with the new alert

## References

- [Metrics Specification](../../claude_assets/metrics_plan.md)
- [Architecture Documentation](../architecture.md)
- [Customization Guide](../customization.md)
- [Prometheus Alert Best Practices](https://prometheus.io/docs/practices/alerting/)
